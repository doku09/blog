# MVCC (Multi-Version Concurrency Control)

## 👥 MVCC란?
다중 버전 동시성 제어라고도 하며, 동시 접근을 허용하는 데이터 베이스에서 **동시성을 제어하기 위해 사용하는 방법** 중 하나이다. 

## 🤔 동시성 문제?
두 사용자가 동시에 데이터 베이스의 같은 데이터를 변경하게 되면 잘못된 값을 읽거나 쓸 수 있다. 이렇게 두개의 트랜잭션이 하나의 자원에 동시에 접근하여 발생하는 문제를 **동시성 문제**라고 한다.

이런 문제를 해결하기 위해 여러 방법이 연구되었는데, 트랜잭션의 Isolation Level 설정, Database Lock, 그리고 오늘 알아볼 **MVCC(Multi-Version Concurrency Control)** 등이 있다.
이들은 서로 보완적으로 작동하며, 데이터의 정합성과 성능 사이의 균형을 맞추는 데 중요한 역할을 한다.

> [🪜 격리레벨 알아보기](./isolationLevel.md)  
> [🔒 DB Lock 알아보기](./lock.md)

---
## 💀 데이터베이스에서의 동시성 문제
> #### 전제조건
> 1. 사용자 A와 B가 있다.  
> 2. x=10 이고,
> 3. y=10 인 두값이 있다.
> #### 표기
> + 사용자A: A
> + 사용자B: B
> + READ(읽기): **r** ([데이터])
> + WRITE(쓰기): **w** ([데이터])


### case1. Non-Repeatable Read
같은 데이터를 같은 트랜잭션 내에서 읽었는데 값이 달라짐
```text
1. 사용자 A는 x값을 두번 읽는다.
2. 사용자 B는 x의 값에 y값을 더한다.

순서
A:r(x): x=10 

B:r(y): y=10
B:r(x): x=10
B:w(x): x=20

A:r(x): x=20
```
📛 

### 🧨 case2. Uncommit Read  (Dirty Read)
다른 트랜잭션이 **아직 커밋하지 않은 데이터를 읽는 문제**.  
롤백이 발생하면 정합성이 깨짐.
```text
A: r(x): x = 10
A: w(x+10): x = 20 (커밋 안함)

B: r(x): x = 20 (커밋되지 않은 데이터 읽음)

A: rollback: x는 다시 10으로 복구됨
```
📛 B는 존재하지 않는 변경을 기반으로 로직을 수행했을 가능성 있음.

### case3. Lost Update
동시 수정으로 인해 한 쪽 변경이 덮어씌워짐
```text
1. 사용자 A는 x의 값에 10을 더한다.
2. 사용자 B는 x의 값에 10을 더한다.

순서
A:r(x): x=10
B:r(x): x=10

A:w(x+10): x=20
B:w(x+10): x=20
```
📛 

### case4. Dirty Read
#### case5. Phantom Read
#### case6. write Skew